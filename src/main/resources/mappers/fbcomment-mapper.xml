<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.devlog.project.board.freeboard.model.mapper.FbCommentMapper">

    <!-- ===============================
         Comment resultMap
    =============================== -->
    <resultMap id="commentFB_rm" type="com.devlog.project.board.freeboard.model.dto.CommentFB">
        <id property="commentNo" column="COMMENT_NO"/>
        <result property="memberNo" column="MEMBER_NO"/>
        <result property="boardNo" column="BOARD_NO"/>
        <result property="parentsCommentNo" column="PARENTS_COMMENT_NO"/>
        <result property="cCreateDate" column="C_CREATE_DATE"/>
        <result property="commentContent" column="COMMENT_CONTENT"/>
        <result property="commentDelFl" column="COMMENT_DEL_FL"/>
        <result property="secretYn" column="SECRET_YN"/>
        <result property="modifyYn" column="MODIFY_YN"/>
        
		  <result property="memberNickname" column="MEMBER_NICKNAME"/>
		  <result property="profileImg" column="PROFILE_IMG"/>        
        
    </resultMap>

    
	<!-- 댓글 삽입 -->
	<insert id="insert" parameterType = "CommentFB"> 
	
		<selectKey order="BEFORE" resultType="_long" keyProperty="commentNo">
			SELECT SEQ_COMMENT_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO "COMMENT"(
            COMMENT_NO,
            MEMBER_NO,
            BOARD_NO,
            PARENTS_COMMENT_NO,
            C_CREATE_DATE,
            COMMENT_CONTENT,
            COMMENT_DEL_FL,
            SECRET_YN,
            MODIFY_YN
        )
		VALUES(
				 #{commentNo},
				 #{memberNo},
				 #{boardNo},
				 <choose>
				     <when test="parentsCommentNo == 0">
				      	NULL
				     </when>
				     <otherwise>
				     		#{parentsCommentNo}
				     </otherwise>
				 </choose>,
				 DEFAULT,
				 #{commentContent},
				 DEFAULT,
				 DEFAULT,
				 DEFAULT
		 )
	</insert>
	
	
	<!-- 댓글 삭제 -->
	<update id="delete" parameterType = "CommentFB">
		UPDATE "COMMENT" SET 
		COMMENT_DEL_FL = 'Y'
		WHERE COMMENT_NO = ${commentNo}	
	</update>
	

	<!-- 댓글 수정 -->
	<update id="update" parameterType = "CommentFB">
		UPDATE "COMMENT" SET 
		COMMENT_CONTENT = #{commentContent}
		WHERE COMMENT_NO = ${commentNo}	
	</update>	
	
	
	<!-- 댓글 목록 조회 (단일 구조) -->
	<select id="select" resultMap="commentFB_rm">
	    SELECT COMMENT_NO,
	           MEMBER_NO,
	           BOARD_NO,
	           TO_CHAR(C_CREATE_DATE, 'YYYY"년" MM"월" DD"일" HH24"시" MI"분"') AS C_CREATE_DATE,
	           COMMENT_CONTENT,
	           MEMBER_NICKNAME,
	           PROFILE_IMG,
	           COMMENT_DEL_FL
	    FROM "COMMENT"
	    JOIN MEMBER USING(MEMBER_NO)
	    WHERE BOARD_NO = #{boardNo}
	      AND COMMENT_DEL_FL = 'N'
	    ORDER BY COMMENT_NO
	</select>    


	<select id="getBoardMemberNo" resultType="_int">
		
		SELECT MEMBER_NO
		FROM BOARD
		WHERE BOARD_NO = ${boardNo}
		
	</select>
	
	<select id="selectMemberNickname" resultType="string">
		
		SELECT MEMBER_NICKNAME
		FROM MEMBER
		WHERE MEMBER_NO = ${memberNo}
	</select>

</mapper>