<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devlog.project.chatting.mapper.ChattingMapper">
	
	<select id="selectChatList" resultType="com.devlog.project.chatting.dto.ChattingDTO$ChattingListDTO">
		SELECT
				CR.CHATTING_ROOM_NO AS "chattingRoomNo",
				CR.ROOM_TYPE AS "roomType",
				CU.PINNED_YN AS "pinnedYn",
				CASE
					WHEN CR.ROOM_TYPE = 'PRIVATE' THEN (SELECT MEMBER_NICKNAME FROM MEMBER M2
														JOIN CHATTING_USER U2 ON M2.MEMBER_NO = U2.MEMBER_NO
														WHERE U2.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
														AND U2.MEMBER_NO != ${memberNo})
					ELSE CR.CHATTING_ROOM_NAME
				END AS "displayName",

				CASE
					WHEN CR.ROOM_TYPE = 'PRIVATE' THEN (SELECT PROFILE_IMG FROM MEMBER M2
														JOIN CHATTING_USER U2 ON M2.MEMBER_NO = U2.MEMBER_NO
														WHERE U2.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
														AND U2.MEMBER_NO != ${memberNo})
					ELSE NVL(CR.ROOM_IMG, '/images/logo.png')
				END AS "roomImg",
				
				CASE
					WHEN M.MESSAGE_STATUS = 'DEL' THEN '삭제된 메세지입니다.'
					ELSE M.MESSAGE_CONTENT
				END AS "lastMessage",
				
				
				TRUNC(M.SEND_TIME, 'MI') AS "lastMessageAt",
				
				(SELECT COUNT(*) FROM MESSAGE M2
					WHERE M2.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
					AND M2.MESSAGE_NO > CU.LAST_READ_NO
					AND M2.MEMBER_NO != CU.MEMBER_NO 
					AND M2.TYPE != 'SYSTEM'
					AND M2.SEND_TIME >= CU.JOIN_DATE) AS "unreadCount"
			
			FROM CHATTING_ROOM CR
			JOIN CHATTING_USER CU
			ON CU.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
			LEFT JOIN MESSAGE M ON M.MESSAGE_NO = 
			(SELECT MAX(m.MESSAGE_NO)
			FROM MESSAGE m
			WHERE m.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
			AND m.TYPE != 'SYSTEM'
			AND m.SEND_TIME >= CU.JOIN_DATE)
			WHERE CU.MEMBER_NO =${memberNo}
			ORDER BY PINNED_YN DESC, M.SEND_TIME DESC NULLS LAST
	</select>
	
	
	<select id="selectQueryChatList" resultType="com.devlog.project.chatting.dto.ChattingDTO$ChattingListDTO">
		SELECT 
		    CR.CHATTING_ROOM_NO AS "chattingRoomNo",
		    CR.ROOM_TYPE AS "roomType",
		    CU.PINNED_YN AS "pinnedYn",
		
		    CASE 
		        WHEN CR.ROOM_TYPE = 'PRIVATE' THEN (
		            SELECT M2.MEMBER_NICKNAME
		            FROM MEMBER M2
		            JOIN CHATTING_USER U2 ON M2.MEMBER_NO = U2.MEMBER_NO
		            WHERE U2.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
		              AND U2.MEMBER_NO != ${memberNo}
		        )
		        ELSE CR.CHATTING_ROOM_NAME
		    END AS "displayName",
		
		    CASE 
		        WHEN CR.ROOM_TYPE = 'PRIVATE' THEN (
		            SELECT M2.PROFILE_IMG
		            FROM MEMBER M2
		            JOIN CHATTING_USER U2 ON M2.MEMBER_NO = U2.MEMBER_NO
		            WHERE U2.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
		              AND U2.MEMBER_NO != ${memberNo}
		        )
		        ELSE CR.ROOM_IMG
		    END AS "roomImg",
		
		    CASE 
		        WHEN M.MESSAGE_STATUS = 'DEL' THEN '삭제된 메세지입니다.'
		        ELSE M.MESSAGE_CONTENT
		    END AS "lastMessage",
		
		    TRUNC(M.SEND_TIME, 'MI') AS "lastMessageAt",
		
		    (
		        SELECT COUNT(*)
		        FROM MESSAGE M2
		        WHERE M2.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
		          AND M2.MESSAGE_NO > CU.LAST_READ_NO
		          AND M2.MEMBER_NO != CU.MEMBER_NO
		          AND M2.TYPE != 'SYSTEM'
		          AND M2.SEND_TIME >= CU.JOIN_DATE
		    ) AS "unreadCount"
		
		FROM CHATTING_ROOM CR
		JOIN CHATTING_USER CU 
		  ON CU.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
		
		LEFT JOIN MESSAGE M 
		  ON M.MESSAGE_NO = (
		        SELECT MAX(m.MESSAGE_NO)
		        FROM MESSAGE m
		        WHERE m.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
		          AND m.TYPE != 'SYSTEM'
		          AND m.SEND_TIME >= CU.JOIN_DATE
		  )
		
		WHERE CU.MEMBER_NO = ${memberNo}
		
		<if test="query != null and query != ''">
		AND (
		    (
		        CR.ROOM_TYPE = 'PRIVATE'
		        AND EXISTS (
		            SELECT 1
		            FROM MEMBER M2
		            JOIN CHATTING_USER U2 ON M2.MEMBER_NO = U2.MEMBER_NO
		            WHERE U2.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
		              AND U2.MEMBER_NO != #{memberNo}
		              AND M2.MEMBER_NICKNAME LIKE '%' || #{query} || '%'
		        )
		    )
		    OR
		    (
		        CR.ROOM_TYPE != 'PRIVATE'
		        AND CR.CHATTING_ROOM_NAME LIKE '%' || #{query} || '%'
		    )
		)
		</if>
		
		ORDER BY CU.PINNED_YN DESC, M.SEND_TIME DESC NULLS LAST

	</select>
	
	
	
	<!-- 팔로우 목록 조회 -->
	<select id="selectFollowList">
		SELECT MEMBER_NO, PROFILE_IMG, MEMBER_NICKNAME 
		FROM MEMBER
		JOIN FOLLOW ON MEMBER_NO = FOLLOWED_ID
		WHERE FOLLOW_ID = ${memberNo}
		<if test="roomNo != null">
			AND MEMBER_NO NOT IN (SELECT MEMBER_NO
								FROM CHATTING_USER
								WHERE CHATTING_ROOM_NO = ${roomNo})
		</if>
		
	</select>
</mapper>