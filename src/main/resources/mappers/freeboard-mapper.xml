<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.devlog.project.board.freeboard.model.mapper.FreeboardMapper">
                  
	
	
    <!-- Freeboard resultMap -->
    <resultMap id="freeboard_rm" type="com.devlog.project.board.freeboard.model.dto.Freeboard">
        <id property="boardNo" column="BOARD_NO"/>
        <result property="boardTitle" column="BOARD_TITLE"/>
        <result property="boardContent" column="BOARD_CONTENT"/>
        <result property="bCreateDate" column="B_CREATE_DATE"/>
        <result property="bUpdateDate" column="B_UPDATE_DATE"/>
        <result property="boardCount" column="BOARD_COUNT"/>
        <result property="boardDelFl" column="BOARD_DEL_FL"/>
        <result property="boardCode" column="BOARD_CODE"/>
        <result property="memberNo" column="MEMBER_NO"/>
        <result property="newsReporter" column="NEWS_REPORTER"/>
        


		  <!-- from MEMBER 테이블  -->
		  <result property="memberNickname" column="MEMBER_NICKNAME" />
		  <result property="profileImg" column="PROFILE_IMG" />
		  <result property="thumbnail" column="THUMBNAIL" />        

		  <!-- from COMMENT, BOARD_LIKE 테이블 -->
		  <result property="commentCount" column="COMMENT_COUNT" />
		  <result property="likeCount" column="LIKE_COUNT" />

       

		  <!-- 이미지 목록 from  BOARD_IMG 테이블 -->
		  <collection property="imageList" select="selectImageList"
			  column="BOARD_NO" javaType="java.util.ArrayList" ofType="BoardImgDB" /> 

		  <!-- 댓글 목록 from  COMMENT 테이블  -->
		  <collection property="commentList"
			  select="selectCommentList" column="BOARD_NO"
			  javaType="java.util.ArrayList" ofType="CommentDB" />          
                    
                    
    </resultMap>

	 <!-- BoardImg랑 Comment위한 resultMap 작성필요=> 객체필드명과 DB컬럼명으로 작성할 수 있다. -->
	 <!-- boardImage resultMap -->
	 <resultMap type="BoardImgDB" id="boardImgDB_rm">
		 <id property="imgNo" column="IMG_NO" />

		 <result property="imgPath" column="IMG_PATH" />
		 <result property="imgRename" column="IMG_RENAME" />
		 <result property="imgOrig" column="IMG_ORIG" />
		 <result property="imgOrder" column="IMG_ORDER" />
		 <result property="boardNo" column="BOARD_NO" />
	 </resultMap>

	 <!-- Comment resultMap -->
	 <resultMap type="CommentDB" id="commentDB_rm">
		 <id property="commentNo" column="COMMENT_NO" />
		 <result property="memberNo" column="MEMBER_NO" />
		 <result property="boardNo" column="BOARD_NO" />
		 <result property="parentsCommentNo" column="PARENTS_COMMENT_NO" />
		 <result property="cCreateDate" column="C_CREATE_DATE" />
		 <result property="commentContent" column="COMMENT_CONTENT" />
		 <result property="commentDelFl" column="COMMENT_DEL_FL" />
		 <result property="secretYn" column="SECRET_YN" />
		 <result property="modifyYn" column="MODIFY_YN" />		 
		 <!--<result property="memberNickname" column="MEMBER_NICKNAME" />
		 <result property="profileImage" column="PROFILE_IMG" /> -->
	</resultMap>
	
	
	<!-- 게시판 종류 조회 -->
	<select id="selectBoardTypeList" resultType="map">
		SELECT * FROM BOARDTYPE 
		ORDER BY 1
	</select>	
	
	
	<!-- 특정 게시판의 삭제되지 않은 게시글 수 조회 -->
	<select id="getFreeboardListCount" resultType="_int">
		SELECT COUNT(*) FROM BOARD
		WHERE BOARD_CODE = ${boardCode}
		AND
		BOARD_DEL_FL = 'N'
		<!-- ORDER BY BOARD_NO DESC -->
	</select>	
	
	
	<!-- 게시글 목록 조회 -->
	<!-- CDATA 태그: 해당 태그 내부에 작성된 것은 모두 문자로 취급: "SYSDATE - B_CREATE_DATE < 1/24/60"안에 '<' 처리위함. not used here -->
	<!-- 일단 아래꺼 다 읽어오는데, 쓰는건: BOARD_NO, BOARD_TITLE,  BOARD_CONTENT, THUMBNAIL 만 목록화면에서 사용예정  -->
	<select id="selectFreeboardList" resultMap="freeboard_rm">
		SELECT BOARD_NO, BOARD_TITLE,  BOARD_CONTENT,
		(SELECT IMG_PATH || IMG_RENAME FROM BOARD_IMG I WHERE I.BOARD_NO = B.BOARD_NO AND IMG_ORDER = 0) THUMBNAIL,
		MEMBER_NICKNAME, BOARD_COUNT,
		<!-- 2025-08-27 11 51 , 2025-08-27 10 51 -->
		         	<![CDATA[
		            CASE  
		               WHEN SYSDATE - B_CREATE_DATE < 1/24/60 
		               THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		               WHEN SYSDATE - B_CREATE_DATE < 1/24 
		               THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60) || '분 전'
		               WHEN SYSDATE - B_CREATE_DATE < 1   
		               THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24) || '시간 전'
		               ELSE TO_CHAR(B_CREATE_DATE, 'YYYY-MM-DD')
		            END B_CREATE_DATE,
		            ]]>
		(SELECT COUNT(*) FROM "COMMENT" C WHERE C.BOARD_NO = B.BOARD_NO AND COMMENT_DEL_FL = 'N') COMMENT_COUNT,
		(SELECT COUNT(*) FROM BOARD_LIKE L	WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT

		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = ${boardCode}
		ORDER BY BOARD_NO DESC
	</select>	
	
	
	<!-- (특정) 게시글 상세 조회 -->
	<!-- board_rm에는 collection 태그 존재
		 -> selectImageList, selectCommentList 실행 후 결과 담음
	 -->
	<select id="selectFreeboardDetail" resultMap="freeboard_rm">
		SELECT BOARD_NO, BOARD_TITLE, BOARD_CONTENT, BOARD_COUNT, MEMBER_NICKNAME, MEMBER_NO, PROFILE_IMG,
		(SELECT IMG_PATH || IMG_RENAME FROM BOARD_IMG I WHERE I.BOARD_NO = B.BOARD_NO AND IMG_ORDER = 0) THUMBNAIL,
			TO_CHAR(B_CREATE_DATE, 'YYYY.MM.DD') B_CREATE_DATE,
			TO_CHAR(B_UPDATE_DATE, 'YYYY.MM.DD') B_UPDATE_DATE,
			(SELECT COUNT(*) FROM BOARD_LIKE L WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT
		FROM BOARD B
		JOIN MEMBER USING(MEMBER_NO)
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = #{boardCode}
		AND BOARD_NO = #{boardNo}
	</select>
		
	
	<!-- 특정 게시글 이미지 조회 -->
   	<select id="selectImageList" resultMap="boardImgDB_rm">
      SELECT * FROM BOARD_IMG
      WHERE BOARD_NO = ${boardNo}
      ORDER BY IMG_ORDER 
   	</select>	
   	
   	
	<!-- 특정 게시글 댓글 조회계층형 쿼리로바꿀예정): 위의 Board resultMap에 Collection으로 추가 => Board 객체에 
		담겨 전달? -> yes(collection 필드) ! -->
	<select id="selectCommentList" resultMap="commentDB_rm">
		SELECT LEVEL, C.* FROM ( 
		    SELECT COMMENT_NO, COMMENT_CONTENT
		    , TO_CHAR(C_CREATE_DATE, 'YYYY"년" MM"월" DD"일" HH24"시" MI"분" SS"초"') C_CREATE_DATE
		    , BOARD_NO, MEMBER_NO, MEMBER_NICKNAME, PROFILE_IMG, PARENTS_COMMENT_NO, COMMENT_DEL_FL
		    FROM "COMMENT"
		    JOIN MEMBER USING(MEMBER_NO)
		    WHERE BOARD_NO = ${boardNo} 
		    ) C 
		WHERE COMMENT_DEL_FL = 'N' 
		START WITH PARENTS_COMMENT_NO IS NULL 
		CONNECT BY PRIOR COMMENT_NO = PARENTS_COMMENT_NO 
		ORDER SIBLINGS BY COMMENT_NO
	</select>	
	   	

	<!-- 상세 게시글 조회수 증가 -->
	<update id="updateBoardCount">
		UPDATE BOARD SET
		BOARD_COUNT = BOARD_COUNT + 1
		WHERE
		BOARD_NO = ${boardNo}
	</update>		
	
	
	<!-- 상세 게시글 좋아요 여부 확인 -->
	<select id="boardLikeCheck" resultType="_int">
		SELECT COUNT(*) FROM
		BOARD_LIKE
		WHERE BOARD_NO = ${boardNo}
		AND MEMBER_NO = ${memberNo}
	</select>

	<!-- 상세 게시글 좋아요 처리: 좋아요 추가 -->
	<insert id="insertBoardLike">
		INSERT INTO BOARD_LIKE VALUES( ${boardNo}, ${memberNo})
	</insert>		
	
		
	<!-- 상세 게시글 좋아요 처리: 좋아요 취소	 -->
	<delete id="deleteBoardLike">
		DELETE FROM BOARD_LIKE
		WHERE BOARD_NO = ${boardNo}
		AND
		MEMBER_NO = ${memberNo}
	</delete>

	   	
	<!-- 좋아요 수 조회 -->
	<select id="countBoardLike" resultType="_int">
		SELECT COUNT(*) FROM
		BOARD_LIKE WHERE BOARD_NO = ${boardNo}
	</select>   	
	
	<!-- 게시글 수정에서 이미지삭제/추가에서 기존이미지 한개 삭제: 먼저 삭제할 이미지가 데이터베이스에 존재하는지 확인(DB삭제 + 파일삭제용), AJAX -->
    <select id="selectImageByImgNo" resultMap="boardImgDB_rm">
        SELECT * FROM BOARD_IMG
        WHERE IMG_NO = ${imgNo}
    </select>	
	
	<!-- 실시간 알림 전용 ============================================-->
	<select id="selectReceiverNo" resultType="Long">
		
		SELECT MEMBER_NO
		FROM BOARD
		WHERE BOARD_NO = ${boardNo}
		
	</select>
	
	<select id="selectMemberNickname" resultType="string">
		SELECT MEMBER_NICKNAME
		FROM MEMBER
		WHERE MEMBER_NO = ${receiver}
		
	</select>
   	
   	<select id="selectBoardTitle" resultType="string">
   		SELECT BOARD_TITLE
   		FROM BOARD
   		WHERE BOARD_NO = ${boardNo}
   	</select>
</mapper>