<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.devlog.project.chatbotTemplate.mapper.CbtTokenUsageMapper">

    <!-- 토큰 사용 기록 삽입 -->
    <insert id="insertTokenUsage" parameterType="CbtTokenUsage">
        <selectKey keyProperty="tkUsageId" resultType="long" order="BEFORE">
            SELECT SEQ_TOKEN_USAGE_NO.NEXTVAL FROM DUAL
        </selectKey>
        
        INSERT INTO CB_TOKEN_USAGE (
            TK_USAGE_ID,
            PROMPT_TEXT,
            ANSWER_TEXT,
            PROMPT_TOKENS,
            ANSWER_TOKENS,
            TOTAL_TOKENTS,
            BEAN_SWE,
            MODEL_NAME,
            MEMBER_NO,
            CB_SESSION_ID
        ) VALUES (
            #{tkUsageId},
            #{promptText},
            #{answerText},
            #{promptTokens},
            #{answerTokens},
            #{totalTokens},
            #{beanSwe},
            #{modelName},
            #{memberNo},
            #{cbSessionId}
        )
    </insert>
    
    <!-- 특정 회원의 총 토큰 사용량 조회 -->
    <select id="getTotalTokensByMemberNo" parameterType="long" resultType="int">
        SELECT NVL(SUM(TOTAL_TOKENTS), 0)
        FROM CB_TOKEN_USAGE
        WHERE MEMBER_NO = #{memberNo}
    </select>
    
    <!-- 특정 세션의 총 토큰 사용량 조회 -->
    <select id="getTotalTokensBySessionId" parameterType="long" resultType="int">
        SELECT NVL(SUM(TOTAL_TOKENTS), 0)
        FROM CB_TOKEN_USAGE
        WHERE CB_SESSION_ID = #{cbSessionId}
    </select>
    
    <!-- 특정 회원의 토큰 사용 내역 조회 -->
    <select id="getTokenUsageListByMemberNo" parameterType="long" resultType="CbtTokenUsage">
        SELECT 
            TK_USAGE_ID,
            PROMPT_TEXT,
            ANSWER_TEXT,
            PROMPT_TOKENS,
            ANSWER_TOKENS,
            TOTAL_TOKENTS,
            BEAN_SWE,
            MODEL_NAME,
            MEMBER_NO,
            CB_SESSION_ID
        FROM CB_TOKEN_USAGE
        WHERE MEMBER_NO = #{memberNo}
        ORDER BY TK_USAGE_ID DESC
    </select>
    
    <!-- 회원의 총 사용 커피콩 조회 -->
    <select id="getTotalBeansByMemberNo" parameterType="long" resultType="int">
        SELECT NVL(SUM(BEAN_SWE), 0)
        FROM CB_TOKEN_USAGE
        WHERE MEMBER_NO = #{memberNo}
    </select>

</mapper>
